const getEnvPath=e=>{switch(e){case"dev":return"dev.pdp.gokwik.co";case"production":default:return"pdp.gokwik.co";case"sandbox":return"sandbox.pdp.gokwik.co";case"qa":return"qa.pdp.gokwik.co"}},CORE_FUNCTION_EVENTS=Object.freeze({LOGOUT_BUTTON_CLICK:"kp_logout_button_click",SUCCESSFULLY_LOGGED_OUT:"kp_successfully_logged_out",REDIRECRED_TO_ACCOUNT_PAGE:"kp_redirected_to_account_page",process_fingerprinting:"process_fingerprinting",store_visitor_information:"store_visitor_information",store_data_from_merchant:"store_data_from_merchant"}),CORE_TOKEN_SESSION_TYPE=Object.freeze({VERIFIED:"verified",KP_SESSION:"kp_session_type",KP_VALID_SESSION:"kp_valid_session"});function openIframe(e="",o=null){const t=getValueFromCookiesOrLocalStorage("kp-request-id"),n=getNotifyPh("non_authed_info"),i=getNotifyPh("kp_non_otp_verified_user"),r=getNotifyPh("kpUnauthPhoneNumber"),a=kpGetCookieValue("KP_META_UID");let s={type:"process-sso",event:e,mid:window.merchantInfo.mid,requestId:t,kcPhoneNumber:o,isLogout:sessionStorage.getItem("isLogout")};o&&(e===CORE_FUNCTION_EVENTS.process_fingerprinting?s.visitorId=o:e===CORE_FUNCTION_EVENTS.store_visitor_information?s.visitorInfo=o:e===CORE_FUNCTION_EVENTS.store_data_from_merchant?s.queryparams=o:s.kcPhone=o),null!=a&&(s.externalId=a),n&&(s.nonAuthedInfo=n),i&&(s.nonOtpVerifiedPhone=i),r&&(s.appUnauthPhoneNumber=r);let l=document.getElementById("iframe-kp");l||(l=document.createElement("iframe"),l.src=`https://${getEnvPath(window.merchantInfo.environment)}/kwikpass/kwikpass-sso.html`,l.id="process-sso",l.style.display="none",document.body.appendChild(l)),l&&(l.contentWindow&&l.contentWindow.postMessage({...s},"*"),l.onload=function(){l.contentWindow.postMessage({...s},"*")})}function getDeviceWidth(){return window.innerWidth}function checkCookieExists(e){const o=document.cookie.split(";");for(const t of o){const[o]=t.split("=").map((e=>e.trim()));if(o===e)return!0}return!1}const kpGetCookieValue=e=>{const o=document.cookie.split(";").map((e=>e.trim()));for(const t of o){const[o,n]=t.split("=");if(o===e)return n}return null},kpGetLocalStorageValue=(e,o=!0)=>o&&localStorage.getItem(e),kpSetCookie=(e,o,t,n=!1,i)=>{let r="",a="";if(t||i){const e=new Date;t&&e.setDate(e.getDate()+t),i&&e.setTime(e.getTime()+60*i*1e3),r="; expires="+e.toUTCString()}n&&(a=";domain="+getPdpUrl()),document.cookie=e+"="+(o||"")+r+"; SameSite=None; Secure; path=/"+a},getValueFromCookiesOrLocalStorage=(e,o=!0)=>{if("notify_phone_number"===e)return getNotifyPh();const t=kpGetCookieValue(e);if(null==t){return kpGetLocalStorageValue(e,o)}return t},setValueInCookiesAndLocalStorage=(e,o,t=!0,n=365)=>{kpSetCookie(e,o,n),t&&window.localStorage.setItem(e,o),e===XGokwikCoreToken(window.merchantInfo.environment)&&setValueInIDB(e,o)},kpDeleteLocalStorageValue=(e,o=!0)=>{o&&localStorage.removeItem(e)};function kpDeleteCookie(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}const deleteValueFromCookiesAndLocalStorage=(e,o=!0)=>{kpDeleteCookie(e),kpDeleteLocalStorageValue(e,o),e===XGokwikCoreToken(window.merchantInfo.environment)&&deleteValueInIDB(e)};function extractRGBValues(e,o=1){const t=e.match(/\d+/g);if(t){return`rgba(${parseInt(t[0])},${parseInt(t[1])},${parseInt(t[2])},${o})`}return null}function findBackgroundColor(e){for(;e;){const o=window.getComputedStyle(e).backgroundColor;if(o&&"rgba(0, 0, 0, 0)"!==o)return o;e=e.parentElement}return"rgba(255,255,255,1)"}function XGokwikCoreToken(e){return"dev"===e||"local"===e||"hdev"===e||"qatwo"===e||"ndev"===e||"idev"===e?"SANDBOXKWIKSESSIONTOKEN":"production"===e||"pci-prod"===e?"KWIKSESSIONTOKEN":"sandbox"===e?"SANDBOXKWIKSESSIONTOKEN":"qa"===e?"QAKWIKSESSIONTOKEN":"SANDBOXKWIKSESSIONTOKEN"}function XGokwikToken(e){return"dev"===e||"local"===e||"hdev"===e||"qatwo"===e||"ndev"===e||"idev"===e?"DEVKWIKUSERTOKEN":"production"===e||"pci-prod"===e?"KWIKUSERTOKEN":"sandbox"===e?"SANDBOXKWIKUSERTOKEN":"qa"===e?"QAKWIKUSERTOKEN":"DEVKWIKUSERTOKEN"}const getKwikpassCheckoutToken=e=>{switch(e){case"dev":default:return"DEVKWIKPASSTOKEN";case"production":return"KWIKPASSTOKEN";case"sandbox":return"SANDBOXKWIKPASSTOKEN";case"qa":return"QAKWIKPASSTOKEN"}},hndlRedrctn=e=>{if(sessionStorage.getItem("is_rn_view")){const o=new CustomEvent("kp_redrc",{detail:{rdrct_to:e}});window.dispatchEvent(o)}else window.location.href=e};function getNotifyPh(e=null){const o=kpGetLocalStorageValue("notify_phone_number")||kpGetCookieValue("notify_phone_number");if(o){const e=btoa(o);return setValueInCookiesAndLocalStorage("notifyph",e),deleteValueFromCookiesAndLocalStorage("notify_phone_number"),o}const t=getValueFromCookiesOrLocalStorage(e||"notifyph");return t?atob(t):null}function handleLogout(e="/account/logout",o={}){const t=getNotifyPh(),n=new CustomEvent("snowplow_event",{detail:{category:"logged_in_page",action:"click",label:"logout_button_click",property:"phone_number",value:t,analyticEvent:CORE_FUNCTION_EVENTS.LOGOUT_BUTTON_CLICK}});window.dispatchEvent(n);const i=new CustomEvent("kp_user_logged_out");window.dispatchEvent(i);const r=document.getElementById("logout-button-desktop"),a=document.getElementById("logout-button-mobile");a&&(a.setAttribute("disabled","disabled"),a.style.opacity="0.7"),r&&(r.setAttribute("disabled","disabled"),r.style.opacity="0.7"),sessionStorage.setItem("isLogout",!0),deleteValueFromCookiesAndLocalStorage(XGokwikToken(window.merchantInfo.environment)),deleteValueFromCookiesAndLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),deleteValueFromCookiesAndLocalStorage(getKwikpassCheckoutToken(window.merchantInfo.environment)),deleteValueFromCookiesAndLocalStorage("kp_phone_number"),deleteValueFromCookiesAndLocalStorage("isAccountPageLogin"),deleteValueFromCookiesAndLocalStorage("KP_API_KEY"),deleteValueFromCookiesAndLocalStorage("IS_SSO_LOGIN"),deleteValueFromCookiesAndLocalStorage("KC_PHONE"),deleteValueFromCookiesAndLocalStorage("kpToken"),deleteValueFromCookiesAndLocalStorage("idb_ph_no"),sessionStorage.removeItem("isShopifySession"),deleteValueFromCookiesAndLocalStorage("notifyph"),sessionStorage.removeItem(CORE_TOKEN_SESSION_TYPE.KP_SESSION),sessionStorage.removeItem(CORE_TOKEN_SESSION_TYPE.KP_VALID_SESSION),sessionStorage.removeItem("isLoginTagUpdate"),kpDeleteCookie("kp_notification_checked"),sessionStorage.removeItem("KP_CUSTOMER_EMAIL_DATA"),sessionStorage.removeItem("isInternationalUser"),sessionStorage.removeItem("KP_CUSTOMER_EMAIL_DATA_ERROR"),sessionStorage.removeItem("KP_CUSTOMER_EMAIL_DATA_MANUAL_LOGIN"),isDropdownVisible=!1,isDropdownMobileVisible=!1,localStorage.removeItem("kp_email"),localStorage.removeItem("kp_multiple_email"),localStorage.removeItem("kp_customer_id"),localStorage.removeItem("kp_customer_state"),localStorage.removeItem("needsToUpdatePhone"),localStorage.removeItem("SHOPIFY_REDIRECT_LINK"),kpDeleteCookie("coupon_applied","/"),r&&(r.removeAttribute("disabled"),r.style.opacity="1"),a&&(a.removeAttribute("disabled"),a.style.opacity="1");const s=new CustomEvent("snowplow_event",{detail:{category:"logged_in_page",action:"logged_out",label:"successfully_loggedout",property:"phone_number",value:t,analyticEvent:CORE_FUNCTION_EVENTS.SUCCESSFULLY_LOGGED_OUT}});window.dispatchEvent(s),"string"!=typeof e&&(e=null),hndlRedrctn(e||"/account/logout")}function handleKpAndShopifyLogin(e,o=!1,t={}){let n=null;e&&(n=e);const i=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),r=sessionStorage.getItem(CORE_TOKEN_SESSION_TYPE.KP_SESSION),a=getCustomerId();if(i&&JSON.parse(r)!==CORE_TOKEN_SESSION_TYPE.VERIFIED&&"true"!==sessionStorage.getItem("isLogout"))handleLogout();else if(null===n)if(i&&"true"!==sessionStorage.getItem("isLogout")){const e=new CustomEvent("kp-sso-custom-shopify-login",{detail:{sso_login:!0}});window.dispatchEvent(e)}else{const e=new CustomEvent("open_login_modal",{detail:{customLogin:o,params:t}});window.dispatchEvent(e)}else if(i)a||handleShopifyLogin(null,n);else{const e=new CustomEvent("open_login_modal",{detail:{isKpAndShopifyLogin:!0,redirectLink:n,params:t}});window.dispatchEvent(e)}}function handleShopifyLogin(e,o,t){const n=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),i=sessionStorage.getItem(CORE_TOKEN_SESSION_TYPE.KP_SESSION);if(n&&JSON.parse(i)!==CORE_TOKEN_SESSION_TYPE.VERIFIED){const e=new CustomEvent("open_login_modal",{detail:{isKpAndShopifyLogin:!0,redirectLink:o}});window.dispatchEvent(e)}else{let n=e?.target;if(null===getCustomerId()){const e=new CustomEvent("shopify-session",{detail:{redirectUrl:o,isManualLoginEnable:t}});isElementsWithAccountClickable&&(isElementsWithAccountClickable=!1,n?.classList?.add("kp-disabled-text-color"),setTimeout((()=>{isElementsWithAccountClickable=!0,n?.classList?.remove("kp-disabled-text-color")}),2e3),window.dispatchEvent(e))}else{const e=getNotifyPh(),t=new CustomEvent("snowplow_event",{detail:{category:"logged_in_page",action:"automated",label:"redirected_to_account_page",property:"phone_number",value:e,analyticEvent:CORE_FUNCTION_EVENTS.REDIRECRED_TO_ACCOUNT_PAGE}});window.dispatchEvent(t),hndlRedrctn(o)}}}function shopifyCheckout(e){e.preventDefault();const o=new CustomEvent("shopify-session",{detail:{redirectUrl:"/checkout",isManualLoginEnable:!1}});window.dispatchEvent(o)}function kp_trigger_popup(e){if(e){const o=new CustomEvent("open_login_autoload",{detail:{autoloadPopupId:e}});window.dispatchEvent(o)}}function handleDOMUpdate(){token=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment));const e=sessionStorage.getItem("isLogout"),o=getValueFromCookiesOrLocalStorage("notify_phone_number");(!token&&!e||token&&!o)&&openIframe("kp_sso_token")}function kpHandleLogin(e,o,t){const n=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),i=getCustomerId();n&&null!=i&&e?hndlRedrctn(e):handleKpAndShopifyLogin(e,o,t)}const DB_NAME="KP_DB",STORE_NAME="kp_storage",DB_VERSION=1;function openDB(){return new Promise(((e,o)=>{const t=indexedDB.open(DB_NAME,DB_VERSION);t.onupgradeneeded=e=>{const o=e.target.result;o.objectStoreNames.contains(STORE_NAME)||o.createObjectStore(STORE_NAME)},t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}async function setValueInIDB(e,o){const t=(await openDB()).transaction(STORE_NAME,"readwrite");return t.objectStore(STORE_NAME).put(o,e),t.complete||new Promise(((e,o)=>{t.oncomplete=e,t.onerror=o}))}async function deleteValueInIDB(e){const o=(await openDB()).transaction(STORE_NAME,"readwrite");return o.objectStore(STORE_NAME).delete(e),o.complete||new Promise(((e,t)=>{o.oncomplete=e,o.onerror=t}))}